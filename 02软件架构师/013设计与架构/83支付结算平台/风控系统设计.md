[参考资料]
[基于红黑树的高效IP归属地查询方案](https://mp.weixin.qq.com/s?__biz=MjM5MDI3MjA5MQ==&mid=2697266795&idx=1&sn=196e1f628459e5bb86b7f76cf410ce87&chksm=8376f95fb401704917d03a05b9f31013e879f49012b184041220f89b34cf3075b83c51667131&scene=21#wechat_redirect)

在实时风控系统中会涉及到非常多的数据衍生和解析，比如IP归属地解析、手机号归属地解析、银行卡卡BIN解析等等。


#核心概念
数据衍生
数据解析

1.IP归属地解析
2.手机号归属地解析
3.银行卡卡BIN解析

###IP归属地解析示例
* **传统做法**，IP存储到关系型数据库，高吞吐时无法满足，实际上就是一张很大的表
* **当前做法**，IP归属地信息保存到内存中，经过一系列的转变，最终形成红黑树，利用红黑树高效的查找性能，实现了高效的IP归属地解析方案，该方案可承担较大的并发访问压力，并拥有极低的响应延时，具体方案如下。

    读取数据库中IP到内存->转化IP地址信息成索引形式->将索引存储到红黑树->从树中读IP->转化为具体地址信息

在TCP/IP协议中，IP地址以二进制形式出现，共4个字节，32bit，由网络编号N-ID和主机编号H-ID组成，根据网络地址的不同，分为5类，A类、B类、C类、D类、E类。对于同一物理网络的计算机，其网络编号相同，而主机编号不同。为各城市分配IP时，通常是将多个连续的IP地址段分配给某一个城市，例如：1.12.0.0 到1.12.255.255，1.15.168.0到1.15.191.255等连续的IP地址段都属于北京的IP地址。由于IP是有4个字节组成的，并且没有负数，可以把**IP地址段转成两个8字节的long类型整数**，在这两个整数之间的数字都属于该城市的IP地址。（需要long？）

IP地址是由4段组成的，如1.15.168.0，其对应的4字节二进制形式为00000001.00001111.10101000.00000000
根据计算机的计算特性，可以把第一段左移24位、第二段左移16位、第三段左移8位、第四段不移动，得到整数相加就是IP地址转换后的整数值，即16777216 + 983040 + 43008 + 0 =17803264。


是每个结点都带有红色或者黑色的**二叉查找树**，是比较高效的，可以在O(log n)时间内做查找，插入和删除，这里的n是树中元素的数目。红黑树在满足二叉查找树的要求外，还必须满足一下要求：
1、节点是红色或黑色。
2、根是黑色。
3、所有叶子都是黑色（叶子是NIL节点）。
4、每个红色节点必须有两个黑色的子节点。（从每个叶子到根的所有路
径上不能有两个连续的红色节点。）
5、从任一节点到其每个叶子的所有简单路径都包含相同数目的黑色节点。

JSON是一中数据格式，主要用于数据交换，易于人阅读和编写，同时也易于计算机解析和生成。

本系统中，IP地址的归属地信息包含了国家（country）、地区（region）、市（city）等属性。
首先把IP地址信息从数据库中以JSON格式读取到计算机内存中，例如：

    {"region":"天津","start":"1.15.232.0","end":"1.15.232.255","city":"天津","country":"中国"}，
    {"region":"辽宁","start":"1.14.33.0","end":"1.14.33.255","city":"大连","country":"中国"}，
    {"region":"北京","start":"1.15.186.0","end":"1.15.186.255","city":"北京","country":"中国"}，
    {"region":"北京","start":"1.12.27.0","end":"1.12.27.255","city":"北京","country":"中国"}，

其中start为数据该城市连续IP段的起始IP，end为结束IP。
这样当type为1时表示一个国家，为2时表示一个省，为4时表示一个城市，为3时表示国家名和地区名相同，为5时表示国家名和城市名相同，为7时表示国家、地区、城市的名称相同。转换后的数据如下所示

|type| name|
|:--|:--|
|1|中国| 
|6|天津| 
|2|辽宁| 
|4|大连| 
|6|北京| 
<mark>表1</mark>
然后再把上面的Area类的集合数据转成**raw-meta**数据，其中index位Area类的集合的索引。

|type| name|index|
|:--|:--|:--|
|1|中国| 0|
|6|天津| 1|
|2|辽宁| 2|
|4|大连| 3|
|6|北京| 4|
<mark>表2</mark>
然后再根据IP地址信息和表2中的raw-meta数据转换成**fomatted-raw-ip**数据，其中国家索引为IP地址信息中country字段对应的表2中index列的相应值，地区索引为region字段对应的表2中index列的相应值，城市索引为city字段对应的表2中index列的相应值。

|国家索引| 地区索引|城市索引|开始IP|结束IP|
|:--|:--|:--|:--|:--|
|0|1| 1|1.15.232.0|1.15.232.255|
|0|2| 3|1.14.33.0 |1.14.33.255|
|0|4| 4|1.15.186.0|1.15.186.255|
|0|4| 4|1.12.27.0|1.12.27.255|
<mark>表3</mark>
进一步，表3中第3、4行的国家索引、地区索引，城市索引是相同，都是国家为中国，地区为北京，城市为北京，为了消除重复数据，再把fomatted-raw-ip数据转换为**segment-regions-ip**数据。

|国家索引| 地区索引|城市索引|formatted-raw-ip索引|
|0|1| 1|0|
|0|2| 3|1|
|0|4| 4|2|
<mark>表4</mark>
然后再把IP归属地信息和segment-regions-ip数据转为compact-ex-ip-segment数据，其中第一行为segment-regions-ip的索引。

|segment-regions-ip索引|开始IP|结束IP|
|:--|:--|:--|
| 0|1.15.232.0|1.15.232.255|
| 1|1.14.33.0 |1.14.33.255|
| 2|1.15.186.0|1.15.186.255|
| 2|1.12.27.0|1.12.27.255|
<mark>表5</mark>
表5的IP地址转换成long整数。

|segment-regions-ip索引|开始IP|结束IP|
|:--|:--|:--|
| 0|1789648| 17819903 |
| 1| 17703168 | 17703423 |
| 2| 17570560 | 17570815 |
| 2| 17807872 | 17808127 |
<mark>表6</mark>
最后把compact-ex-ip-segment转成红黑树保存在计算机内存中，每个红黑树结点由parent，left，right，color，from，end，index组成。parent 为父节点，left为左结点  right为右结点，color 表示该结点为红色或者黑色，from为起始IP转成的long整数，end为结束IP转成的long整数，index为compact-ex-ip-segment数据保存的索引，即表6的第一次列。

由于红黑树中存放的是IP段的起始IP转换后的整数和结束IP转换后的整数，而需要查询的是具体IP地址转换后的整数，因此查询的规则是：先把IP转换为整数，从红黑树的root结点开始查起，当该整数小于结点中的from整数时，继续沿着红黑树该结点的左边查找，当该整数大于结点中的end整数时，继续沿着红黑树中该结点的右边查找，否则，该查找到的结点即为要查找的IP信息对应的结点。

若查找过程中，结点为NIL节点，说明该IP地址不是有效的IP。例如IP地址为1.15.186.10，首先把IP转成long型的整数，即17807882。然后去红黑树中查找该整数对应的红黑树中的结点为2，17807872，17808127，进而取到索引2，即segment-regions-ip的索引，根据表4取到数据0,4,4,2，其中2为fomatted-raw-ip集合的索引，0,4,4为raw-meta数据的最后一列，即为Area类集合的索引，从而找到country为0，即中国，region为4，即北京，city为4即北京。因此该IP对应的国家为中国、地区为北京、城市为北京。

当红黑树形成以后，在具体IP查询过程中，从数据库中读取的IP地址信息的JSON格式数据已经不再需要，可以从内存中删除。最终留在内存中的数据为Area类的集合，segment-regions-ip数据，红黑树，这样就可以减少计算机内存的使用。经统计，本系统中IP地址信息的总条数为719296，经过对系统启动前后，计算机内存的比较，系统启动后共占用了大约20兆（MB）的内存，在现在计算机技术快速发展的时代，一般家用的计算机的内存也有2千兆（GB）或者更多，公司专门的服务器的内存甚至高达几十GB，因此这些数据的内存占用量可以说是微不足道的。
      
当IP地址信息的条数增加时，只需要以目前的格式添加到数据库中，然后重启应用程序即可，当需要更详细的IP地址信息时，比如经纬度、运营供应商，除了在数据库中添加相应信息外，只需要增加Area类的相应信息的字段，重启应用程序即可，因此，此系统具有良好的扩展性。

该方案不仅适用于IP归属地查询，也适用于其他相对静态的数据的快速解析。









