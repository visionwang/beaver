


# 核心技术栈 #




# Java微服务 #


![](http://i.imgur.com/Skj3TJS.png)


# 环境搭建 #
1.购买阿里云服务器，CPU2核，内存4GB，活动期间购买3年，比较实惠。
2.搭建Docker环境
3.在Docker上搭建各类相关环境
4.
使用nexus搭建maven私服
http://blog.csdn.net/pucao_cug/article/details/52444347
搭建git server

搭建gitlab server

搭建jenkins server

搭建cat服务

搭建zabbix服务

搭建druid服务


# 技术架构参考 #

[去哪儿支付系统架构演进](http://www.cnblogs.com/luckcs/articles/6273119.html)：很棒的文章，很好的介绍了Qunar支付系统的架构，尤其是支付网关等模块非常值得借鉴。




[架构设计之性能设计经验](http://www.cnblogs.com/Mainz/archive/2007/12/15/996082.html)

性能(performance)设计非常重要，对于服务器端实时交易系统来说系统性能的重要性不言而喻，对客户端软件来说性能好的软件也会获得良好的用户体验，从而给用户留下高质量软件的良好印象。因此在进行架构设计中性能设计非常重要。

      但架构设计实际是一个平衡设计，在可用性、可扩展性、可维护性、可靠性、高性能等之间做个妥协选择。这些非功能性的需求再加上复杂的功能性需求，同时还要考虑到项目管理上tight schedule, low cost, perfect effect的三角难题约束，有时需求还不是很明确，vision不是很清楚，这种情况下系统架构设计真是一门艺术。(可参考笔者另外一篇文章《也谈系统设计的一些原则》)

      单就性能设计来说，在架构设计初期就一定要把系统性能考虑在内，否则等开发完成以后测试发现性能不好就比较难办，通常要花费较长的时间来诊断性能瓶颈，找到提升的办法，甚至要改变架构，伤筋动骨，往往造成项目延期。所以性能设计首先要有明确的性能目标，根据用户和软件本身的性能要求来设计，合适的就是最好的。其次，要有适当的度量标准和量化的性能指标。最后，要有相应的设计策略，具体的测试方法。

      根据我的经验，影响系统性能主要瓶颈在I/O，包括数据库，socket，网络通信，文件等，例如频繁查询数据库并返回大量结果集，频繁操作大文件等，这些昂贵的操作会占用大量的CPU时间。拿系统响应和服务一个事务来说，有几个Round trip，要通过哪几层I/O，如何合理的分配这些I/O的调用，降低不必要的I/O，都是进行系统性能设计要考虑的。而有些性能问题在初期并不会表现出来，但当拿到实际上线环境下，存在多用户并发、大数据量的情况下就会暴露出严重的问题。所以性能设计时一定要考虑到I/O，同步，并发，资源争用，以及大数据量等因素。通常，I/O操作、网络响应、差的算法、数据库、以及其他的低效的资源使用都会导致低劣的性能。

具体可用的设计策略有：

l        缓存以及缓存层(caching layer)

    在数据层和应用层之间增加数据缓存层，提供全局数据服务。可以大大减少数据库往返次数。与读取数据库和读取大文件（如XML文件）比，读取内存的速度无疑要快的多。所以对经常要访问的数据进行缓存是非常好的实践方法。因为现在系统往往内存很大，可以充分利用大内存，而共享内存更能实现数据并发访问。

l        多线程(multi-threading)

    现在基本上大部分软件实现多线程或多进程，多线程对单CPU系统还只是顺序利用CPU时间和改善用户体验，多CPU系统才是真正的并行。要注意的是多线程不要争抢访问同一资源而导致部分串行操作，要做到真正的并行操作多线程并不容易。另外，在多线程间同步一个庞大的资源，过多创建线程又没有实现线程池也会导致系统性能下降。

l        负载平衡(load balancing)

    物理上增加地位对等的集群服务器（Cluster），通过负载分配算法分配相应服务器来相应客户端请求。很多系统支持负载均衡，Windows server2003 IIS就支持负载均衡服务，其他如WebLogic, WebSphere也有集群版本支持负载均衡。当然你也可以自己实现负载分配算法。

l        数据库优化（database optimization）

   如果应用程序使用了数据库，可以采取许多步骤来消除访问和写入数据时的瓶颈：

Ø         标识潜在的索引，但不要创建过多的索引。

Ø         如果使用 SQL Server，则使用 SQL Server 的事件探查器和索引优化向导。

Ø         监视处理器的使用；理想范围是：75-80% 处理器时间。

Ø         使用查询分析器分析查询计划以优化查询。

Ø         使用存储过程优化性能。

Ø         标准化写入的大量数据 —写入较少的数据。

Ø         取消标准化读取的大量数据 —读取较少的数据。


l        文件系统优化

     有时候系统性能不好，但当你关闭写log的功能，性能一下子提高很多。因为频繁的打开关闭大log文件时I/O开销非常大，同样记录log到数据库也一样。所以，release版尽量减少写log，或干脆移到裸设备上。

      频繁打开关闭文件对系统性能下降程度是惊人的，可以通过一些变通办法来减少文件的频繁操作。
      例如，原来的缓存持久化实现是保存在XML文件，每次要获得一个配置项，都打开XML文件，通过XPath拿到这个配置项的值，这样效率不高，而且容易把这个XML文件lock住；改进的方法是：通过比较XML文件的修改时间(System.IO.File.GetLastWriteTime)判断是否要再次打开文件，大大提高了效率；另一个可以改进的方法是：启动时读取所有配置到一个静态的HashTable，每次要获得一个配置项都从内存HashTable获取，在最后或适当的时候持久化到XML。



l        代码性能设计

             在编程实现上，代码性能设计也很重要，一些昂贵的操作会占用大量的资源和CPU时间。例如，字符串相加没用StringBuilder, 频繁创建对象，差劲的排序或递归算法，过多的装箱拆箱，过多的使用反射（Reflection），频繁new HashTable或大的数组，用异常（Catch Exception）用做正常的逻辑，使用复杂的正则表达式，等等。具体可以参考《Effective C++》《Effective C#》等书籍。

l  语言的选择

   另外，语言选择也很重要。比如相对于Java, C#, C++, 大多数OLTP系统用C语言效率高的多，因为在所有的高级程序设计语言中，C程序设计语言的运行效率是公认的。再比如我们熟悉的一些框架，框架本身是C#或是Java的，但其核心独立模块是C++封装的，这样可以达到最佳的性能。所以对于一些特定的业务需求目标和数据的具体情况，对于核心的模块或算法，可以用特定的语言来实现以获得更好的效率。

l  应用层   

    比如应用层和数据库的API，在.Net中就有就有DataReader、DataSet和IList等的选择以及转换等，这个根据具体情况而定；还有就是大家常采用的数据的格式化和压缩，以及采用分页，减少传输的数据量；是否可以把一部分处理逻辑放在客户端呢，减少服务端的工作量。界面端也是有很多针对性能优化的考虑，例如绘图，控件重绘都是非常耗资源的，各控件的数据加载和数据绑定性能也各不相同，尽量采用惰性加载，异步加载；初始化和启动速度等都是需要考虑和优化的。


   这些只是我项目经验积累和归纳，水平有限，项目有限，认识更有限，欢迎大家指正补充。







大型网站架构系列：电商网站架构案例(1)
大型网站架构是一个系列文档，欢迎大家关注。本次分享主题：电商网站架构案例。从电商网站的需求，到单机架构，逐步演变为常用的，可供参考的分布式架构的原型。除具备功能需求外，还具备一定的高性能，高可用，可伸缩，可扩展等非功能质量需求（架构目标）。

根据实际需要，进行改造，扩展，支持千万PV，是没问题的。
本次分享大纲（需要一个学习大纲，非常棒）
电商案例的原因
电商网站需求
网站初级架构
系统容量估算
网站架构分析
网站架构优化
架构总结


电商网站案例，一共有三篇本篇主要说明网站的需求，网站初始架构，系统容量估算方法。

一、电商案例的原因

分布式大型网站，目前看主要有几类1.大型门户，比如网易，新浪等；2.SNS网站，比如校内，开心网等；3.电商网站：比如阿里巴巴，京东商城，国美在线，汽车之家等。大型门户一般是新闻类信息，可以使用CDN，静态化等方式优化，开心网等交互性比较多，可能会引入更多的NOSQL，分布式缓存，使用高性能的通信框架等。电商网站具备以上两类的特点，比如产品详情可以采用CDN，静态化，交互性高的需要采用NOSQL等技术。因此，我们采用电商网站作为案例，进行分析。

二、电商网站需求

客户需求：

建立一个全品类的电子商务网站（B2C），用户可以在线购买商品，可以在线支付，也可以货到付款；
用户购买时可以在线与客服沟通；
用户收到商品后，可以给商品打分，评价；
目前有成熟的进销存系统；需要与网站对接；
希望能够支持3~5年，业务的发展；
预计3~5年用户数达到1000万；
定期举办双11，双12,三八男人节等活动；
其他的功能参考京东或国美在线等网站。


客户就是客户，不会告诉你具体要什么，只会告诉你他想要什么，我们很多时候要引导，挖掘客户的需求。好在提供了明确的参考网站。因此，下一步要进行大量的分析，结合行业，以及参考网站，给客户提供方案。

其他的略~~~~~

需求功能矩阵

需求管理传统的做法，会使用用例图或模块图（需求列表）进行需求的描述。这样做常常忽视掉一个很重要的需求（非功能需求），因此推荐大家使用需求功能矩阵，进行需求描述。

本电商网站的需求矩阵如下：

 

网站需求

功能需求

非功能需求

全品类的电子商务网站

分类管理，商品管理

方便进行多品类管理（灵活性）

网站访问速度要快（高性能）

图片存储的要求（海量小图片）

用户可以在线购买商品

会员管理，购物车，结算功能

良好购物体验（可用性，性能）

在线支付或货到付款

多种在线支付方式

支付过程要安全，数据加密（安全性）

多种支付接口灵活切换（灵活性，扩展性）

可以在线与客服沟通

在线客服功能

可靠性：即时通讯

商品打分评价

商品评论

 

目前有成熟的进销存系统

对接进销存

属于约束条件

对接时要考虑数据一致性，鲁棒性

支持3~5年，业务的发展

 

属于约束条件

伸缩性，可扩展性

3~5年用户数达到1000万

 

约束条件

举办双11，双12,三八男人节等活动

活动管理，秒杀

突增访问流量（可伸缩）

实时性要求（高性能）

参考京东或国美在线

 

参考条件

 

 

 

 

以上是对电商网站需求的简单举例，目的是说明（1）需求分析的时候，要全面，大型分布式系统重点考虑非功能需求；（2）描述一个简单的电商需求场景，使大家对下一步的分析设计有个依据。

 

三、网站初级架构

一般网站，刚开始的做法，是三台服务器，一台部署应用，一台部署数据库，一台部署NFS文件系统。

这是前几年比较传统的做法，之前见到一个网站10万多会员，垂直服装设计门户，N多图片。使用了一台服务器部署了应用，数据库以及图片存储。出现了很多性能问题。

如下图：

 

但是，目前主流的网站架构已经发生了翻天覆地的变化。一般都会采用集群的方式，进行高可用设计。至少是下面这个样子。

 

（1）       使用集群对应用服务器进行冗余，实现高可用；（负载均衡设备可与应用一块部署）

使用数据库主备模式，实现数据备份和高可用；

四、系统容量预估

预估步骤：

（1）       注册用户数-日均UV量-每日的PV量-每天的并发量；

（2）       峰值预估：平常量的2~3倍；

（3）       根据并发量（并发，事务数），存储容量计算系统容量。

 

客户需求：3~5年用户数达到1000万注册用户；

 

每秒并发数预估：

（1）       每天的UV为200万（二八原则）；

（2）       每日每天点击浏览30次；

（3）       PV量：200*30=6000万；

（4）       集中访问量：24*0.2=4.8小时会有6000万*0.8=4800万（二八原则）；

（5）       每分并发量：4.8*60=288分钟，每分钟访问4800/288=16.7万（约等于）；

（6）       每秒并发量：16.7万/60=2780（约等于）；

（7）       假设：高峰期为平常值的三倍，则每秒的并发数可以达到8340次。

（8）       1毫秒=1.3次访问；

 

没好好学数学后悔了吧？！（不知道以上算是否有错误，呵呵~~）

 

服务器预估：（以tomcat服务器举例）

（1）       按一台web服务器，支持每秒300个并发计算。平常需要10台服务器（约等于）；[tomcat默认配置是150]

（2）       高峰期：需要30台服务器；

 

容量预估：70/90原则

系统CPU一般维持在70%左右的水平，高峰期达到90%的水平，是不浪费资源，并比较稳定的。内存，IO类似。

 

以上预估仅供参考，因为服务器配置，业务逻辑复杂度等都有影响。在此CPU，硬盘，网络等不再进行评估。










**参考资料**
1. 李智慧. 大型网站技术架构[M]. 北京:电子工业出版社, 2013.


