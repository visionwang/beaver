
运营需求在离线场景下，已经得到了较为系统化的支持，通过对离线数据收集、挖掘，可对目标用户进行T+1触达，通过向目标用户发送Push等多种方式，在一定程度上提高转化率。但T+1本身的延迟性会导致用户在产生特定行为时不能被实时触达，无法充分发挥数据的价值，取得更优的运营效果。
在此背景下，运营业务需要着手挖掘用户行为实时数据，如实时浏览、下单、退款、搜索等，对满足运营需求用户进行实时触达，最大化运营活动效果。


**业务场景**
在运营实时触达需求中，存在如下具有代表性的业务场景：
用户在30分钟内发生A行为次数大于等于3次
用户为老客，即用户曾购买过酒店产品
用户在A行为前24小时内未发生B行为
用户在A行为后30分钟内未发生B行为（排除30分钟内用户自发产生B行为的影响，降低对结果造成的偏差）

早期方案
运营实时触达需求早期活动数量较少，我们通过为每个需求开发一套Storm拓扑相关代码、将运营活动规则硬编码这一“短平快”的方式，对运营实时触达需求进行快速支持

规则引擎是处理复杂规则集合的引擎。通过输入一些基础事件，以推演或者归纳等方式，得到最终的执行结果。规则引擎的核心作用在于将复杂、易变的规则从系统中抽离出来，由灵活可变的规则来描述业务需求。由于很多业务场景，包括酒旅运营实时触达场景，规则处理的输入或触发条件是事件，且事件间有依赖或时序的关系，所以规则引擎经常和CEP（复合事件处理）结合起来使用。

规则引擎调研
在设计规则引擎前，我们对业界已有的规则引擎，主要包括Esper和Drools，进行了调研。
Esper
Esper设计目标为CEP的轻量级解决方案，可以方便的嵌入服务中，提供CEP功能。
优势
轻量级可嵌入开发，常用的CEP功能简单好用。
EPL语法与SQL类似，学习成本较低。
劣势
单机全内存方案，需要整合其他分布式和存储。
以内存实现时间窗功能，无法支持较长跨度的时间窗。
无法有效支持定时触达（如用户在浏览发生后30分钟触达支付条件判断）。

由于业务规则对时间窗功能及定时触达功能有较强的依赖，综合以上两种规则引擎的优劣势，我们选用了相对SpEL更为轻量的表达式引擎Aviator，将流式数据处理及规则引擎集成至Storm中，由Storm保证系统在数据处理时的吞吐量，在系统处理资源出现瓶颈时，可在公司托管平台上调整Worker及Executor数量，降低系统水平扩展所需成本。

技术方案
确定引入规则引擎后，围绕规则引擎的设计开发成为了系统建设的主要着力点。通过使用实时数据仓库中的用户实时行为数据，按业务运营活动规则，组合成有意义的复合事件，交由下游运营业务系统对事件的主体，也就是用户进行触达。将系统抽象为以下功能模块，如图2所示：

总体来看，系统组成模块及功能如下：

规则引擎：集成于Storm拓扑中，执行运营活动条件转换成为的具体规则，作出对应响应。
时间窗模块：具有可选时间跨度的滑动时间窗功能，为规则判定提供时间窗因子。
定时触达模块：设定规则判定的执行时间，达到设定时间后，执行后续规则。
自定义函数：在Aviator表达式引擎基础函数之上，扩展规则引擎功能。
报警模块：定时检查系统处理的消息量，出现异常时为负责人发送报警信息。
规则配置控制台：提供配置页面，通过控制台新增场景及规则配置。
配置加载模块：定时加载活动规则等配置信息，供规则引擎使用。




规则引擎在执行规则过程中，涉及以下数据模型：

场景：业务需求的抽象，一个业务需求对应一个场景，一个场景由若干规则组成。用不同的规则组成时序和依赖关系以实现完整的业务需求。
规则：规则由规则条件及因子组成，由路由至所属场景的事件触发，规则由规则条件、因子及规则响应组成。
规则条件：规则条件由因子构成，为一个布尔表达式。规则条件的执行结果直接决定是否执行规则响应。
因子：因子是规则条件的基础组成部分，按不同来源，划分为基础因子、时间窗因子和第三方因子。基础因子来源于事件，时间窗因子来源于时间窗模块获取的时间窗数据，第三方因子来源于第三方服务，如用户画像服务等。
规则响应：规则执行成功后的动作，如将复合事件下发给运营业务系统，或发送异步事件进行后续规则判断等。
事件：事件为系统的基础数据单元，划分为同步事件和异步事件两种类型。同步事件按规则路由后，不调用定时触达模块，顺序执行；异步事件调用定时触达模块，延后执行。

对于以上特点，在评估使用场景和接入数据量级的基础上，我们选择公司基于Tair研发的KV的存储服务Cellar存储时间窗数据，经测试其在20K QPS请求下，TP99能保证在2ms左右，且存储方面性价比较高，可以满足系统需求。

在实际运营活动中，对时间窗内用户某种行为次数的判断往往在5次以内，结合此业务场景，同时为避免Value过大影响读写响应时间，在更新时间窗数据时设置阈值，对超出阈值部分进行截断。时间窗数据更新及截断流程如图4所示：

**参考资料**
滑动窗口
