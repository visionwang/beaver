https://zhuanlan.zhihu.com/p/28758202

一、数据平台技术选型
1、整体框架
像消息队列这一层，我们选用了Kafka，这是目前大家普遍用到的，因为它有高吞吐量，采用Push和Pull结合的方式（关于pull和监听的思考），消费端主动拉取数据。ETL这块，目前大家都希望采用一种可以自定义的方式，一般来说比较流行的是用LinkedIn提供的Camus来做从Kafka到HDFS的数据同步。这应该是一种较为流行的架构。
![](https://i.imgur.com/u7i2pH6.png)

那么放到HDFS上面的数据，基本上是为了**批处理**做准备的，那么在批处理分析的时候，我们选择一个什么样的分析引擎，可能就是一个值得争议的焦点，也就是说，也许在这个分析引擎的下面，**有Hive，有Spark，**有Presto，有Impala，还有其它的东西。
当前在GitHub上面能找到的Presto webui的就是Airbnb提供的AirPal？

作为搜索引擎，社区这一块，大家耳熟能详的应该是Elasticsearch，Elasticsearch的社区非常活跃，而且它的推广速度，应用型上面易都很好。但是Elasticsearch的难点在于如何对它进行好的维护，后面我会讲到它可能存在的维护痛点。

插件Elastisearch-SQL，这样就可以采用SQL语句对Elasticsearch进行点查询或者范围查询。

WebUI是人机交互的部分，我们会进行Ad-hoc查询，但在整个部门当中有不少程序希望调用查询，也就是应用的接口，采用SOA的架构，我们自己开发实现了 BigQuery API

2、ETLPipeLine -- Gobblin
![](https://i.imgur.com/1efp9l6.png)
这个是ETL相对比较细节的一些东西。快速过一下这个图。在ETL的时间当中，比如说为什么不直接用像Spark或者流的方式，最常见的问题就是小文件的问题，到时候需要清理合并小文件，这很麻烦。如果采用Zeus去调度，然后设定一定数目的Partition，就有一个Map Task对应，尽可能的写满一个Block，以64M或者128M为主。在存储的时候我们除了考虑它的大小之外，存储格式的选择也应该是必须考量的范围。
从我们当前的选择来看，建议使用**ORC这样的文件格式**，采用这个文件格式是由于它已经内嵌了一定级别的索引，尽管索引不是非常细粒度，但是在某些层面是能够急速地提高检索，跳过不符合条件的数据块，避免不必要的数据传输。目前相对比较有希望的，或者大力推广的一个格式就是**华为公司在推的CarbonData**，它含有的索引粒度，索引信息比ORC更加细致。他们目前也出了1.×的版本，是相对来讲较为成熟一个版本。

3、分析引擎 -Presto
![](https://i.imgur.com/hzHWf0Y.png)
这里讲的是Presto的内部机理。为什么不用Hive和Spark？Hive相当于是俄国的武器，**特点就是傻大黑粗**，绝对的稳定，稳定到什么程度？稳定到就是它是最慢的一个，有一个笑话就是我的成绩一直很稳定，因为老考倒数第一，没人可以比过，所以一直很稳定，而正数第一不见得很稳定，Hive就是这个特点，绝对可以出来结果，但是会让你觉得人生没有指望。

Spark的特点就是它名头绝对的够响，但是会发觉Spark具体的使用过程当中有些问题？资源共享是一个问题，如果说你光用Spark，肯定Concurrent Query出现问题的，要前置一个东西，比如Livy或者什么东西来解决掉你的资源共享问题。而且Spark的雄心很大，几乎想把所有东西都吃下去，所有东西都吃，就很难，因为你要涉及很多的领域。

Presto只专注于数据的分析，只关注SQL查询层面，只做一件事，这个充分体现了Unix的哲学，遵循只干一件活，不同的活通过Pipeline的方式串起来。而且Presto是基于流水线的，只要有一个块当中结果出来了，然后比如说我们最典型的就是后面加一个后置的条件，然后limit 10或者Limit 1，你会发觉很快出来结果

从Presto后面给出的这些数据可以看到，这种层面上的一个提升。基于ORC的文件存储，它的提升应该是5倍或者10倍，10倍到20倍的提升。它的架构简单来说是有一个Client，然后这个Client提交SQL语句过来，前面有一个Planner和Scheduler，会把相应的SQL的东西分层，分成不同的Stage，每一个Stage有多个Task，这些真正的Task是运行在不同的Workers上面，利用这些Workers去数据源读取数据。

分析引擎比较——Presto与MapReduce
![](https://i.imgur.com/TJ1igQS.png)
大家可以看到我刚才提到一个基于Stage的方式，一个基于Pipeline的方式，Pipeline的方式就是整个过程中，处理没有停顿，整个是交叉的，它不会等上一个Stage完成后再进行下一个Stage，Spark的特点就是等到一个Stage结束了，数据吐到Disk中，下一个Stage再去拉数据，然后再进行下一个。Pipeline就是说我有一个Task处理完，直接将数据吐到下一个Task，直到Aggregator节点。
那么在这个过程当中，你也会看到Presto的一个最大特点就在于所有的计算就在内存当中，你会想到人的大脑，机器的内存都是有限的，会崩掉了，崩掉就崩掉了，早死早超生，大不了再跑一趟，这就是Presto的一个基本原则。

4、近实时搜索 –Elasticsearch
下面讲讲ES层面的东西，也就是近实时的搜索引擎，它所有的东西都是基于Lucene上面进行一个包裹，对JSON支持的非常好。同时Elasticsearch支持横向、水平扩展，高可用，易于管理，社区很活跃，背后有专门的商业公司。它的竞品就是Solr，Solr的Cloud，SolrCloud安装较为复杂，引入了独立的第三方东西，对ZooKeeper集群有极大的依赖，这样使得Solr Cloud的管理变得复杂。

ES调优和运维
第一个层面就是OS， 讲到Linux， 调优过程中自然会考虑到它的**文件句柄数**，然后它的Memory，它的I/O的调度，I/O的调度线如果在座各位对内核比较感兴趣的话，你会发现基本使用CFQ，因为在生产环节上大多会采用Redhat或者CentOS来部署

5、数据可视化——Zeppelin
在做数据可视化这一块时，可以借鉴竞争对手或者竞品，看看别人在做什么，如果说大家去看Hue， Hue的话，其实就是上面输入查询语句之后，后续就把结果很好地显示出来。

6、数据微服务 –Rest查询接口
微服务这一块，我们提供了一个BigQuery API，这样的好处是有一个统一的查询入口，有统一的权限管理。因为查询时不是所有人都应该看到所有的数据，这很容易出问题，可能有比较实实在在的数据，它不像一般的日志数据，特别像机票或者我们这边的酒店，它的数据有不少的一些敏感信息，这需要做相应的权限管理。

7、任务调度器 –Job Scheduler
https://github.com/ctripcorp/dataworks-zeus
其实在做一套大数据的平台时，少不了任务调度这一块。任务调度这一块我们使用的是Zeus系统，携程在这一块开源出来，由我们公司Ops的团队专门来负责开发和维护个平台。但是你想，通过这个平台递交的任务包括，ETL和定时任务，可以实现将数据从Kafka放入到HDFS或者是把SQL Server和MySQLDB里面的数据同步到HDFS。调度这一块目前市面上的竞品还有AirFlow和其它。

二、数据团队能力建设
许鹏，携程机票大数据基础平台Leader，负责平台的构建和运维。深度掌握各种大数据开源产品，如Spark、Presto及Elasticsearch。著有《Apache Spark源码剖析》一书。


英雄迟暮是怎样的？
https://www.zhihu.com/question/39922893/answer/218372865
他去求学前，将一张纸条夹在父亲账簿里，上面写道：“孩儿立志出乡关，学不成名誓不还，埋骨何须桑梓地，人生无处不青山。”
他说大丈夫要为天下奇，读奇书，交奇友，做奇事，做一个奇男子。
也有独坐池塘如虎踞，绿荫树下养精神。春来我不先开口，哪个虫儿敢作声？

在32岁时写下不朽的词，沁园春·长沙。
在四渡赤水中，更是写下，忆秦娥·娄山关。
我们都知道重庆谈判，他拿出沁园春·雪，轰动重庆。
但是也有七律·忆重庆谈判中的遍地哀鸿遍地血，无非一念救苍生。

因为他知道，没有这些他热爱的人民，就不能为有牺牲多壮志，敢教日月换新天。
**改成城市卫生部或老爷卫生部，或城市老爷卫生部好了！**

不多愁善感，怎么当诗人呢？
但是只是多愁善感，又怎么带领大家，秋风萧瑟今又是，换了人间呢。

在滴水洞思考11天之后，要离开时，工作人员前来提醒，他又自言自语的说了句，又要到白云黄鹤的地方去了，一路上他都显的很沉闷的样子。
他喜欢爬山，喜欢游泳，爬山时不喜欢走回头路下山。
他这一生睡眠很少，靠安眠药有时都不太有用。

但他这个白内障，只会越来越严重，在长达半年的拉锯战中，他同意做手术了，在做手术之前，**他要听岳飞的满江红**，踏着步子，走进手术室。
原来是南宋著名思想家陈亮写的《念奴娇·登多景楼》”。
他晚年喜欢天意从来高难问，况人情老易悲难诉。

昔年种柳，依依汉南；今看摇落，凄怆江潭。树犹如此，人何以堪！
只吃了几口他历来喜欢的武昌鱼和一点米饭就不吃了。

人间一股英雄气、在驰骋纵横！

其实都是相对的，想要不孤独和悲剧，就得装糊涂，就得腿脚利索，赚钱嘛，不寒碜，一代人有一代人的事吧，没有你对我很重要，这隔谁来都做不到，他为何执意呢？其实在他看来，那不过是一场演习，没这场演习，压制他们，我们走的比苏联早，其实也就是一个大号印度。
麻子始终是孤独的，初中读**毛选的时候读出来的是他对人民的无穷热爱，大学再读，我读出来的是刺骨的孤寒**。人民不明白他的意思，被利益集团引导地团团转，有的战友们心怀鬼胎，不少情况为了打击利益集团还要打击自己真正的战友。冷，冷得骨头都在发抖。

他不希望人崇拜他，就像让子弹飞那句不许跪，站起来，没人值得你们跪，我也不值得你们跪，但是很多事情是事与愿违的，就像他在火化上签字的最终不可得，他活着的时候，尤其是晚年是非常痛苦的，底层的人，是爱戴他，他自己也知道，他说要人们克服三千年的崇拜皇帝的习惯很困难，但是这崇拜的里面分三种，一种是真心的，一种是假意的，一种是随波逐流的，怎么打破崇拜？就是自己粉身碎骨呗，失败即成功，虽然我没生活在他的年代，以前也骂过他，历史上找不出这号人物，太特别了，也很迷人。

他晚年的伟大事业是他辉煌一生中最光辉灿烂的一页！
如股票般，拉升前的大洗盘；毛的眼光，早于看穿百年后
没说反，看看文革哪些人闹得欢，哪些人不声不响得了利益，就知道了

看完建军大业又找了毛主席的纪录片看，只能说佩服佩服，一穷二白到今天，什么是奇迹？这就是奇迹
智慧，功绩，艰险，才情，品德，均为千古第一
突然想起那句话，但愿这盛世能如你所愿。


老三国曹操的剧情更还原原著，所以可以展现的部分不多。 二十岁初出茅庐，意气风发，做五色大棒决心洗净丑恶的青年我们看不到。 
前面献刀，反董卓，奉天子，打徐州的戏不找了。老三国曹操演技的巅峰在平河北后吊袁绍

智武
最后感慨一句，对于我们而言，英雄迟暮无非是那个要屠龙的少年，最后长大成了普通人。
曹老板这时才总算明白了，既然用道义拯救不了苍生，那就豁出命去用武力来平定天下。

烈士暮年，壮心不已

白名单，做了么？等等思考一下如何做这些事情？

峣峣者易折，皎皎者易污。阳春白雪，和者盖寡。盛名之下，其实难副。
事物总是要走向反面的，吹得越高跌得越重，我是准备跌得粉碎的。那也没有什么要紧，物质不灭，不过粉碎罢了。
知其不可而为之，虽千万人吾往矣。


六朝何事，只成门户私计。


