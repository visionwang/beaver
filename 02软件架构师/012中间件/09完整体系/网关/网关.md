应小组要求，进行H5网关相关调研，

#携程网关发展
2015年的这个全新架构，实现了无线服务端基于API Gateway的架构框架、客户端的模块化开发、测试与部署，支持运行期间的模块实时加载、按需Lazyloding、Remote加载，从而实现模块级动态升级以及代码级热修复，并且逐步推动数百人的客户端研发团队由不堪重负、效率低下的大版本大火车开发模式向模块间独立迭代、发布轻量级的开发方向演进。

##App服务端架构v1.0
早期App服务端架构使用了传统的PC无线开发架构，即在PC Web应用基础上增加一些无线端的REST接口直接供给App访问，没有考虑架构的扩展性、 灵活性、安全型等因素。
![](http://img.blog.csdn.net/20161017191951459)
如图1所示，服务端系统一方面以Web应用的方式提供给PC端浏览器访问，另一方面为支持移动，在Web应用基础上增加一些REST接口直接供App访问。相应地，无线接口和Web应用作为同一工程开发，作为同一个应用部署，这种架构设计思路是很直接和自然的，可以快速把PC端功能复制到App上，其思想设计是在现有Web应用上打补丁，体现的是PC思维无线化，把App简单作为PC端应用的翻版，并把两者物理上捆绑在一起，在早期也能满足当时的业务需求，但是随着平台化的发展，以及业务越来越复杂和多样性，这种架构设计带来的一些列的问题逐步暴露出来，其中最突出的急需解决的有三个问题：**耦合、重复造轮子、系统稳定性**

**强耦合**
无线接口和Web应用紧耦合，Web端的修改会影响无线接口，Web端的发布导致无线接口被动连带发布，Web端的Bug影响无线接口的可用性，反过来也一样，无线接口的任何变化会影响Web应用。
此外其中酒店无线接口和机票的无线接口，或者其他BU无线的接口，也存在着较为严重的耦合问题，这种耦合带来的问题，最严重最明显的就是这个BU的接口调整或者修改Bug，有可能会影响其他BU接口的稳定型，从而带来每次发布，要带来更多的测试回归工作。
**重复造轮子**
无线接口除了给App提供业务数据，还需要考虑一系列非功能性因素的接口功能验证，如通讯协议和数据格式封装、安全控制、日志记录，性能监控等，这些对每个无线接口都适用。如果App和后端系统直连，意味着每个后端系统都需要单独支持这些通用功能，导致重复开发。一旦这些通用需求有变化（如对数据传输进行加密增强），所有后端系统都要强制同步修改和上线，给项目管理和产品发布带来很大挑战。
**稳定性**
App和多个后端系统直连，只要一个系统出问题，就会影响App的可用性，比如酒店服务出了问题比如变慢或者耗用CPU过多资源，其机票服务或者其他服务会受到一定影响，其典型的弊端就是缺乏故障隔离机制，缺少负载均衡、缺少监控、缺少熔断等影响后端稳定性的问题，导致App的健壮性很差，非常脆弱。

##App服务端架构V2.0
基于架构V1.0三个比较严重的缺点，于是我们开始尝试使用一种新的无线架构V2：基于API Gateway的无线服务端架构。

**对等隔离**
App实际上和PC端浏览器是对等的，PC端应用有服务端，App也需要自己独立的服务端，两个服务端都需要针对自身的特点，独立开发，独立部署，同时实现逻辑和物理层面的解耦，从架构层面彻底摆脱PC思维无线化。（开发两套洛）
**统一服务**
核心逻辑从Web应用剥离出来，进行服务化改造，服务实现时不区分PC和无线，App和Web应用都依赖于这些服务，一套接口，多方调用。
**统一无线API Gateway网关入口，保持系统的稳定性**
提供统一的无线网关，所有App调用指向此网关，**网关包括通用层、接口路由层、适配层**。通用层包括<mark>通讯协议适配、数据封装、安全、监控、日志、隔离、熔断、限流、反爬</mark>这些系统级功能，每个接口调用都需要同样逻辑，这些功能统一由网关前置处理，避免重复开发。具体实现时，每个通用处理逻辑封装成拦截器(filter)，遵循统一的过滤接口，并且做到可配置，网关依次调用这些拦截器，这样可以支持通用逻辑的灵活扩展。
无线API Gateway应该目前很多公司都有自己的实现，目前市场上也提供了很多开源项目Zuul、Archaius、Hystrix、Eureka等帮助我们去实现自己的Gatway。

携程的service和apiservice
美团的service和mapi

###API Gateway具备的功能特点
![](http://img.blog.csdn.net/20161017192114539)
携程**基于Netflix的开源项目Zuul开发了无线APIGateway架构**如上图2所示，其Gateway的职能是负责接收来自无线端的所有API请求，并将他们路由到正确的目标应用服务器，并且提供**限流、隔离、熔断**等功能，保证了无线服务的长期稳定运行，拥有的弹性容错机制也减少了日常运维工作。同时该Gateway提供了**多维度的监控数据，并与报警系统对接，实时监控线上情况，达到运维自动化**。其API Gateway具有的几个核心职能：路由、隔离、限流、熔断、反爬、监控报警，具体如下所示：

* 接口路由：核心功能，需要根据各种条件将请求路由到正确的目的地。在实现上采用了路由服务，Gateway定期从路由服务获取路由表，达到了解耦、实时更新的效果；经过通用逻辑预处理后，无线接口请求将进一步分发给后端处理（各个Adapter）。URL和Adapter在配置文件里做映射，分发逻辑根据请求中的URL信息，找到对应的Adapter，然后把请求交给<mark>Adapter</mark>处理。
* 隔离：由于Gateway接收了所有业务请求，请求多种多样，当某类请求出问题时，不能影响其他请求处理。对此，Gateway实现了资源隔离，防止某类请求将资源耗光，继而影响其他服务。
* 限流：对于任何一类请求，都设置了容量上限，并不能无限制处理。Gateway可以为每类请求设置并发上限，当到达上限时，Gateway将不在转发请求，而是直接返回，保护后端服务。如果在后端服务过载的情况下，仍然转发请求，只会恶化问题。
* 熔断：当一个服务在不能提供服务时，Gateway如果断续向它转发请求，不但不能解决问题，往往还会恶化问题。Gateway引入了一个熔断机制，当某一服务在过去一段时间内的错误比率到达一个阈值，Gateway则停止向该服务转发请求，称之为熔断，特定时间过去后，Gateway会探测此服务是否恢复正常，正常则开始正常转发，若不正常继续熔断。
* 反爬：Gateway积极对接安全接口，会根据**IP、clientId**、以及算法校验阻断非法请求，保护后端服务。
* 监控报警：Gateway接入了Cat、Clog、并对接了运维报警工具。当出现问题时，会及时报警，尽早发现问题，减少损失。

###API Gateway 智能升降级
Gateway支持集中管控的同时，也带来单点问题。假设后台某个服务接口，由于某种原因，性能有严重问题，对应Adapter处理很慢，那么网关所在服务器的线程很快被耗尽，导致单个接口拖垮整个系统。这种问题，单纯通过增加机器，水平扩展网关数量是解决不了的，实践中，我们引入了智能升降级机制来快速隔离单个接口的影响，从而实现了接口的自动隔离熔断机制，其实现原理如图3所示。
![](http://img.blog.csdn.net/20161017192411536)
针对特定一个接口，如果在一定时间间隔内（比如5分钟），它的超时失败率到了一定比例（比如5%），网关会对该接口做降级处理，随机抛弃部分流量，比如只允许50%流量通过。下一个5分钟再评估，如果失败率还没有改善，允许通过的流量降到25%，以此类推。如果成功率好转，网关对该接口做升级处理，提升通过的流量比例，为了快速恢复，一般提升到原流量4倍，然后在下一个时间段再评估是否触发升降级。

整个过程全自动智能处理（为防止误判，可支持人工干预），这样单个接口出问题，不会影响整个网关的处理能力。

###携程App服务端架构演进总结
携程App服务端架构通过一系列的拆分和整合，既优化了公司整体应用架构，又为App做大做强奠定良好基础，其带来的好处是全方面的，增加了架构的可扩展性、健壮性、稳定性、灵活性，并且提高了团队的开发效率和团队长远的收益，其具体表现在：

实现PC端应用和移动端应用分离，使两者彻底解耦，各自独立发展，App从寄生藤变成并蒂莲。携程在做Gateway架构的第一步就是做PC端和无线端的业务解耦，以及各BU之间的业务解耦，实现各BU无线业务和PC业务的独立部署、独立发布。
底层核心的SOA服务基于统一业务规则提供逻辑和数据，接口不区分PC、无线或其他渠道（如Open API），避免重复开发，避免业务逻辑被污染。所有前端一视同仁，而且如果以后增加其他端，也不需要做过的改动，其扩展性和灵活性能满足新业务拓展的需要。
根据无线本身的特点，支持系统层面的集中处理和业务层面的分散处理。通用逻辑支持插件化扩展，可以根据需要逐步补充；Adapter实现内外部接口的无缝转换，可以针对无线场景，做逻辑增强（如服务聚合，客户端性能埋点、接口性能监控）等。
移动研发团队和各业务线研发团队各司其职，每个团队专注于自己擅长部分，移动团队负责App客户端和网关通用逻辑处理，PC服务端负责PC相关的业务逻辑处理，H5服务端负责H5相关的业务逻辑处理，各个研发团队独立研发和发布，不耦合，即各业务线研发团队负责底层SOA服务及前端Adapter适配。



#微服务
在微服务的应用程序中，客户端和微服务之间的交互，有如下几个挑战：
微服务提供的API粒度通常与客户端的需求不同，**微服务一般提供细粒度的API**，也就是说客户端需要与多个服务进行交互。
不同的客户端需要不同的数据，不同类型客户端的网络性能不同。
服务的划分可能会随时间而变化，因此需要对客户端隐藏细节。

王延炯：API Gateway（API GW / API 网关），顾名思义，是出现在系统边界上的一个面向API的、串行集中式的强管控服务，这里的边界是企业IT系统的边界。
在微服务概念的流行之前，API GW的实体就已经诞生了，这时的主要应用场景是OpenAPI，也就是开放平台，面向的是企业外部合作伙伴，对于这个应用场景，相信接触的人会比较多。当在微服务概念流行起来之后，API网关似乎成了在上层应用层集成的标配组件。
![](https://res.infoq.com/news/2016/07/API-background-architecture-floo/zh/resources/1.png)
其实，在我所经历过的项目中，API GW的定位主要有五类：

面向Web App
这类场景，在物理形态上类似前后端分离，此时的Web App已经不是全功能的Web App，而是根据场景定制、场景化的App。

面向Mobile App
这类场景，移动App是后端Service的使用者，此时的API GW还需要承担一部分MDM（此处是指移动设备管理，不是主数据管理）的职能。

面向Partner OpenAPI
这类场景，主要为了满足业务形态对外开放，与企业外部合作伙伴建立生态圈，此时的API GW需要增加配额、流控、令牌等一系列安全管控功能。

面向Partner ExternalAPI
这类场景，业界提的比较少，很多时候系统的建设，都是为了满足企业自身业务的需要，实现对企业自有业务的映射。当互联网形态逐渐影响传统企业时，很多系统都会为了导入流量或者内容，依赖外部合作伙伴的能力，一些典型的例子就是使用「合作方账号登录」、「使用第三方支付平台支付」等等，这些对于企业内部来说，都是一些外部能力。此时的API GW就需要在边界上，为企业内部Service 统一调用外部的API做统一的认证、（多租户形式的）授权、以及访问控制。

面向IoT SmartDevice
这类场景，业界就提的更少了，但在传统企业，尤其是工业企业，传感器、物理设备从工业控制协议向IP转换，导致具备信息处理能力的「智能产品」在被客户激活使用直至报废过程中，信息的传输不能再基于VPN或者企业内部专线，导致物理链路上会存在一部分公网链路。此时的API GW所需要满足的，就是不是前三种单向的由外而内的数据流，也不是第四种由内而外的数据流，「内外兼修」的双向数据流，对于企业的系统来说终端设备很多情况下都不是直连网关，而是进过一个「客户侧」的集中网关在和企业的接入网关进行通信。

InfoQ：在一个微服务架构中，API网关会在架构中的那一层？他主要的作用是什么？
王延炯：接续前一个话题，我把API GW分为了五类，对于当前的企业而言被关注的是前三类或者前四类API GW。显然，它们都会出现在企业系统的边界上，也就是和企业外部交互的「独木桥」上。

它们除了保证数据的交换之外，还需要实现对接入客户端的身份认证、防报文重放与防数据篡改、功能调用的业务鉴权、响应数据的脱敏、流量与并发控制，甚至基于API调用的计量或者计费。

Close亲爱的读者：我们最近添加了一些个人消息定制功能，您只需选择感兴趣的技术主题，即可获取重要资讯的邮件和网页通知。
Chris Richardson曾经在他的博客上详细介绍过API网关，包括API网关的背景、解决方案以及案例。对于大多数基于微服务的应用程序而言，API网关都应该是系统的入口，它会负责服务请求路由、组合及协议转换。如Chris所言，在微服务的应用程序中，客户端和微服务之间的交互，有如下几个挑战：

微服务提供的API粒度通常与客户端的需求不同，微服务一般提供细粒度的API，也就是说客户端需要与多个服务进行交互。

不同的客户端需要不同的数据，不同类型客户端的网络性能不同。

服务的划分可能会随时间而变化，因此需要对客户端隐藏细节。

那API网关具体是如何解决这些问题的，在API网关的落地上，需要注意哪些地方，就这些问题，InfoQ编辑采访了普元主任架构师王延炯，与他一起探讨了API网关的来龙去脉。

InfoQ：谈谈你所理解的API网关，以及API网关出现的背景？

王延炯：API Gateway（API GW / API 网关），顾名思义，是出现在系统边界上的一个面向API的、串行集中式的强管控服务，这里的边界是企业IT系统的边界。

在微服务概念的流行之前，API GW的实体就已经诞生了，这时的主要应用场景是OpenAPI，也就是开放平台，面向的是企业外部合作伙伴，对于这个应用场景，相信接触的人会比较多。当在微服务概念流行起来之后，API网关似乎成了在上层应用层集成的标配组件。



其实，在我所经历过的项目中，API GW的定位主要有五类：

面向Web App
这类场景，在物理形态上类似前后端分离，此时的Web App已经不是全功能的Web App，而是根据场景定制、场景化的App。

面向Mobile App
这类场景，移动App是后端Service的使用者，此时的API GW还需要承担一部分MDM（此处是指移动设备管理，不是主数据管理）的职能。

面向Partner OpenAPI
这类场景，主要为了满足业务形态对外开放，与企业外部合作伙伴建立生态圈，此时的API GW需要增加配额、流控、令牌等一系列安全管控功能。

面向Partner ExternalAPI
这类场景，业界提的比较少，很多时候系统的建设，都是为了满足企业自身业务的需要，实现对企业自有业务的映射。当互联网形态逐渐影响传统企业时，很多系统都会为了导入流量或者内容，依赖外部合作伙伴的能力，一些典型的例子就是使用「合作方账号登录」、「使用第三方支付平台支付」等等，这些对于企业内部来说，都是一些外部能力。此时的API GW就需要在边界上，为企业内部Service 统一调用外部的API做统一的认证、（多租户形式的）授权、以及访问控制。

面向IoT SmartDevice
这类场景，业界就提的更少了，但在传统企业，尤其是工业企业，传感器、物理设备从工业控制协议向IP转换，导致具备信息处理能力的「智能产品」在被客户激活使用直至报废过程中，信息的传输不能再基于VPN或者企业内部专线，导致物理链路上会存在一部分公网链路。此时的API GW所需要满足的，就是不是前三种单向的由外而内的数据流，也不是第四种由内而外的数据流，「内外兼修」的双向数据流，对于企业的系统来说终端设备很多情况下都不是直连网关，而是进过一个「客户侧」的集中网关在和企业的接入网关进行通信。

InfoQ：在一个微服务架构中，API网关会在架构中的那一层？他主要的作用是什么？

王延炯：接续前一个话题，我把API GW分为了五类，对于当前的企业而言被关注的是前三类或者前四类API GW。显然，它们都会出现在企业系统的边界上，也就是和企业外部交互的「独木桥」上。

它们除了保证数据的交换之外，还需要实现对接入客户端的身份认证、防报文重放与防数据篡改、功能调用的业务鉴权、响应数据的脱敏、流量与并发控制，甚至基于API调用的计量或者计费。

InfoQ：你有研究过Netflix的API网关吗？在实现方式上，你觉得他们的方式有什么巧妙之处吗？
王延炯：Netflix 的API GW，主要是指Zuul, Netflix 将他们用于自己的三大场景： Website Service, API Service, Streaming Service。其中前两个定位与我的前两个分类：Web App, Mobile App比较类似，第三个Streaming Service主要是netflix的核心视频业务所形成的特有形态。

Netflix在Zuul的实现上，主要特色是：Filter的PRE ROUTING POST ERROR（PRPE 模型），以及采用Groovy脚本的Filter实现机制、采用Cassandra作为filter repository的机制。

Filter 以及 Filter的PRPE模型，是典型的「前正后反模型」的实现，为集成的标准化做好了框架层面的铺垫。

Netflix其实并没有对API GW进行深入的功能实现（或者说面相业务友好的相关功能），整体上它只提供了一个技术框架、和一些标准的filter实例实现，相信了解过filter chain原理的分布式中间件工程师也能搭出这样的框架。这么做的原因，我认为很大原因是API GW所扮演的角色是一个业务平台，**而非技术平台**，将行业特征很强的业务部分开源，对于受众意义也不是特别大。另外，除了Netflix Zuul，在商业产品上还有apigee公司所提供的方案，在轻量级开源实现上还有基于**Nginx的kong**，kong其实提供了19个插件式的功能实现，涵盖的面主要在于安全、监控等领域，但缺少对报文转换的能力（为什么缺 也很显而易见——避免**产生业务场景的耦合**，更通用）。
另外，还有基于TCP协议的GW，比如携程无线应用的后端实现有HTTP和TCP两种，有兴趣的读者也可以深入关注
TCP长连接？http短连接？

InfoQ：在API网关的设计上，需要包含哪些要素？
王延炯：从三个方面说吧，API网关本身以及API网关客户端，还有配套的自助服务平台。具体如下：
**API GW本身**
NIO接入，异步接出
流控与屏蔽
秘钥交换
客户端认证与报文加解密
业务路由框架
报文转换
HTTP DNS/ Direct IP
**API GW 客户端 SDK / Library**
基本通信
秘钥交换与Cache
身份认证与报文加解密
**配套的在线自助服务平台**
代码生成
文档生成
沙盒调测

InfoQ：在API网关的落地上，你有可行的方案吗？在API网关的落地上，难点是什么？

王延炯：在我所服务过的阿里系、非电商互联网公司里，内部的分布式服务调用采用的是Dubbo，但移动应用是iOS和Android，基本上没有PC Web端的客户端，在这种条件下，API GW所承担的一个重要角色就是报文转换，并且是跨语言、跨运行平台的报文转换。报文就是数据，在跨平台、跨语言的条件下，对于数据的描述——元数据——也就是类定义，对于API GW的系统性挑战是巨大的：传输时，报文内不能传输类定义，跨语言的类定义转换、生成与加载。

API GW的落地技术基本贯通没有太大的难度，但形成最佳的实践，有一些外围的前置条件，比如：

**后端API粒度**
能和原子业务能力找到映射最好，一定要避免「万能接口」的出现。
**业务路由的实现和含报文转换的API不停机发布**
尽可能的在报文头里面存放业务路由所需要的信息，避免对报文体进行解析。
API GW上线后，面临的很大问题都是后端服务如何自助发布到外部，同时不能重启网关服务，以保障业务的连续。在此过程中，如果涉及到报文格式的转换，那对API网关实现的技术要求比较高。如果让网关完成报文转换，第一种方案，网关需要知道报文的具体格式（也就是报文的元数据，或者是类定义），这部分要支持热更新。第二种方案，需要客户端在报文内另外附加元数据，网关通过运行期加载元数据对报文进行解析在进行报文的转换，这种方案性能不会很好。第三种方案，就是在运行期首次报文转换的时候，根据元数据生成报文转换代码并加载，这种方案对技术实现要求比较高，对网关外围平台支撑力度要求也不低。
**客户端的秘钥管理**
很多人都会把安全问题简单的用加密算法来解决，这是一个严重的误区，很多时候都存在对秘钥进行系统性管理的短板。打个比方，加密算法就好比家里的保险箱，而秘钥是保险箱的钥匙，而缺乏秘钥管理的安全方案，就好比把钥匙放在自家的客厅茶几上。更何况，安全方案里加解密也只是其中的一部分。

InfoQ：你认为一个设计良好的API网关应该做到什么？
王延炯：目前业界关注的API GW，主要是在前三类，下文对于API网关的设计上，侧重于「面向接入」的API GW。

在API网关的设计上，仅仅有类似Zuul这样的**「面向接入」的运行期框架**是远远不够的，因为一个完整的、「面向接入」的API GW需要包含以下功能：
面向运行期

对客户端实现身份认证
通信会话的秘钥协商，报文的加密与解密
日常流控与应急屏蔽
内部响应报文的场景化裁剪
支持「前正后反模型」的集成框架
报文格式的转换
业务路由的支撑
客户端优先的超时机制
全局流水号的生成与应用
面向客户端支持HTTP DNS / Direct IP
面向开发期

自助的沙盒测试环境
面向客户端友好的 SDK / Library以及示例
能够根据后端代码直接生成客户端业务代码框架
完善的报文描述能力（元数据），支撑配置型的报文裁剪
面向运维与运营

支持面向接入方的独立部署与快速水平扩展
面向业务场景或合作伙伴的自助API开通
对外接口性能与线上环境故障定位自助平台



http://blog.didispace.com/hzf-ms-apigateway-2/

点到那个页面，
http2.0是什么意思？



**参考资料**
[谈API网关的背景、架构以及落地方案](http://www.infoq.com/cn/news/2016/07/API-background-architecture-floo)
[springcloud(十)：服务网关zuul初级篇](https://mp.weixin.qq.com/s?__biz=MzI4NDY5Mjc1Mg==&mid=2247483902&idx=1&sn=dac5fc9ad74d4317fe23b949e038b086&chksm=ebf6d981dc815097698bd3778379396ac9d7ec0d7f33ed66f3800f912a285ecee19a2cad757d&scene=21#wechat_redirect)
[springcloud(十一)：服务网关Zuul高级篇](https://mp.weixin.qq.com/s/h5RiyMwHcQtoqU1N4dcmMg)
[携程移动端架构演进与优化之路](http://blog.csdn.net/younger_z/article/details/52851339?locationNum=11&fps=1)
[携程大数据实践：高并发应用架构及推荐系统案例](http://geek.csdn.net/news/detail/96708)
[携程在线风控系统架构](http://blog.csdn.net/qq_36852006/article/details/78250028)
[携程移动端性能优化](http://weixin.niurenqushi.com/article/2017-01-03/4739613.html)
[各大互联网公司架构演进之路汇总](http://blog.csdn.net/libraryhu/article/details/50821801)
[干货 | 关于反爬虫，看这一篇就够了](https://mp.weixin.qq.com/s?__biz=MjM5MDI3MjA5MQ==&mid=2697265241&idx=2&sn=f2965d124d07fe5efcdc85094eb1c2df&scene=1&srcid=06304xa9GCL3BIkgKNDyMWLW&from=singlemessage&isappinstalled=0&key=77421cf58af4a6537bcd6dda69d225f4b1e7595a7beea4d57e188e38ba9aa0512c299ac2f8695d60ae8ccada799cc466&ascene=1&uin=MTAzNTE0NzIw&devicetype=iPhone+OS9.3.2&version=16031610&nettype=WIFI&fontScale=100&pass_ticket=gV66yDOco4Kurm7qlxe9IVeaC3ENgZvD2/zhHO1z7G8=)
[Pattern: API Gateway / Backend for Front-End](http://microservices.io/patterns/apigateway.html)
[微服务架构技术栈选型手册（万字长文）](https://baijiahao.baidu.com/s?id=1591145666249286839&wfr=spider&for=pc)
[微服务与API 网关（下）- Kong能为我们做什么？](http://blog.didispace.com/hzf-ms-apigateway-2/)
[聊聊 API Gateway 和 Netflix Zuul](http://www.scienjus.com/api-gateway-and-netflix-zuul/)
[微服务与API网关（上）: 为什么需要API网关？](http://blog.didispace.com/hzf-ms-apigateway-1/)
[聊聊Twemproxy是什么](http://blog.csdn.net/u010601183/article/details/54426289)

